name: Sync ORCID Publications
on:
  schedule:
    - cron: '0 0 * * 0' # Runs every Sunday at midnight
  workflow_dispatch: # Allows you to trigger it manually

jobs:
  orcid-to-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install bibtexparser
        run: pip install bibtexparser

      - name: Fetch and Convert ORCID
        run: |
          # 1. Fetch BibTeX from your specific ORCID
          curl -L "https://pub.orcid.org/v3.0/0000-0003-3376-0260/works" -H "Accept: application/x-bibtex" > papers.bib
          
          # 2. Run python script to create the .md files Jekyll expects
          python - <<EOF
          import bibtexparser
          import os

          if not os.path.exists('_publications'):
              os.makedirs('_publications')

          with open('papers.bib') as bibtex_file:
              bib_database = bibtexparser.load(bibtex_file)

          for entry in bib_database.entries:
              # Logic for Paper Types
              category = "Journal"
              if entry.get('ENTRYTYPE') == 'inproceedings':
                  category = "Conference"
              elif entry.get('ENTRYTYPE') == 'book':
                  category = "Book"
              
              # Creating a safe filename
              clean_id = entry['ID'].replace('/', '_')
              filename = f"_publications/{entry.get('year', '0000')}-{clean_id}.md"
              
              with open(filename, 'w') as f:
                  f.write("---\n")
                  f.write(f"title: \"{entry.get('title', 'Untitled')}\"\n")
                  f.write(f"collection: publications\n")
                  f.write(f"category: {category}\n")
                  f.write(f"date: {entry.get('year', '0000')}-01-01\n")
                  f.write(f"venue: \"{entry.get('journal', entry.get('booktitle', 'Unknown'))}\"\n")
                  f.write("---\n")
                  f.write(f"\n{entry.get('abstract', 'No abstract available.')}\n")
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name 'ORCID-Bot'
          git config --global user.email 'bot@github.com'
          git add _publications/*.md
          # The '|| exit 0' ensures the workflow doesn't fail if there's nothing new to commit
          git commit -m "Auto-sync ORCID publications" || exit 0
          git push
