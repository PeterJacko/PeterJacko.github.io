name: Sync ORCID to Single Bib
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Append BibTeX
        run: |
          mkdir -p _publications
          echo "" > _publications/papers.bib
          
          # 1. Fetch the full activities summary (JSON)
          curl -H "Accept: application/json" "https://pub.orcid.org/v3.0/0000-0003-3376-0260/activities" > summary.json
          
          # 2. Python logic with deeper path finding
          python3 - <<EOF
          import json
          import requests
          import time

          try:
              with open('summary.json') as f:
                  data = json.load(f)
          except Exception as e:
              print(f"JSON Load Error: {e}")
              exit(1)

          # Debugging: Print the top-level keys to see where 'works' is hiding
          print(f"Root keys: {list(data.keys())}")
          
          # The path is usually activities-summary -> works -> group
          activities = data.get('activities-summary', {})
          works_obj = activities.get('works', {})
          groups = works_obj.get('group', [])

          print(f"Work groups found: {len(groups)}")

          if not groups:
              print("Attempting fallback path for groups...")
              groups = data.get('group', []) # Original path check

          with open('_publications/papers.bib', 'a') as bib_file:
              for group in groups:
                  summaries = group.get('work-summary', [])
                  if not summaries: continue
                      
                  put_code = summaries[0].get('put-code')
                  url = f"https://pub.orcid.org/v3.0/0000-0003-3376-0260/work/{put_code}"
                  res = requests.get(url, headers={"Accept": "application/x-bibtex"})
                  
                  if res.status_code == 200:
                      bib_file.write(res.text + "\n\n")
                      print(f"Added: {put_code}")
                  time.sleep(0.1)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name 'ORCID-Bot'
          git config --global user.email 'bot@github.com'
          git add _publications/papers.bib
          git commit -m "Updated papers.bib" || exit 0
          git push
