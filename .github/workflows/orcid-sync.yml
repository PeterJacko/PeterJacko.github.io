name: Sync ORCID to Single Bib
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Run Sync Script
        run: |
          python3 - <<EOF
          import requests
          import os
          import time

          orcid_id = "0000-0003-3376-0260"
          output_file = "_publications/papers.bib"
          
          if not os.path.exists("_publications"):
              os.makedirs("_publications")

          # 1. Fetch using the most reliable endpoint for your profile
          print(f"Fetching summary for {orcid_id}...")
          url = f"https://pub.orcid.org/v3.0/{orcid_id}/works"
          response = requests.get(url, headers={"Accept": "application/json"})
          
          if response.status_code != 200:
              print(f"API Error: {response.status_code}")
              exit(1)

          data = response.json()
          
          # 2. Extract put-codes (Scanning multiple possible paths)
          put_codes = []
          groups = data.get('group', [])
          if not groups:
              # Try alternative path
              groups = data.get('activities-summary', {}).get('works', {}).get('group', [])
          
          for group in groups:
              summaries = group.get('work-summary', [])
              for work in summaries:
                  code = work.get('put-code')
                  if code:
                      put_codes.append(code)

          print(f"Total IDs found: {len(put_codes)}")

          # 3. Download individual BibTeX and FORCE write
          bib_entries = []
          for code in put_codes:
              work_url = f"https://pub.orcid.org/v3.0/{orcid_id}/work/{code}"
              res = requests.get(work_url, headers={"Accept": "application/x-bibtex"})
              if res.status_code == 200 and len(res.text) > 10:
                  bib_entries.append(res.text)
                  print(f"Downloaded: {code}")
              time.sleep(0.1)

          # 4. Final Write (This ensures the file is updated)
          with open(output_file, 'w') as f:
              if bib_entries:
                  f.write("\n\n".join(bib_entries))
                  print(f"SUCCESS: Wrote {len(bib_entries)} entries.")
              else:
                  f.write("% No entries found at " + time.ctime())
                  print("No entries found.")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name 'ORCID-Bot'
          git config --global user.email 'bot@github.com'
          git add _publications/papers.bib
          # Added --allow-empty to ensure the action doesn't hang or fail
          git commit -m "Updated papers.bib: $(date)" || echo "No changes to commit"
          git push
