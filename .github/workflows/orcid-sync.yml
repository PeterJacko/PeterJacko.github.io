name: Sync ORCID to Single Bib
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Run Sync Script
        run: |
          python3 - <<EOF
          import requests
          import os
          import time

          orcid_id = "0000-0003-3376-0260"
          output_dir = "_publications"
          output_file = os.path.join(output_dir, "papers.bib")
          
          if not os.path.exists(output_dir):
              os.makedirs(output_dir)

          # 1. Fetch the activities summary via Requests
          print(f"Fetching summary for {orcid_id}...")
          summary_url = f"https://pub.orcid.org/v3.0/{orcid_id}/activities"
          response = requests.get(summary_url, headers={"Accept": "application/json"})
          
          if response.status_code != 200:
              print(f"Failed to fetch summary. Status: {response.status_code}")
              exit(1)

          data = response.json()
          
          # Navigate the nested JSON structure
          groups = data.get('activities-summary', {}).get('works', {}).get('group', [])
          print(f"Found {len(groups)} work groups.")

          # 2. Fetch individual BibTeX entries
          bib_content = []
          for group in groups:
              summaries = group.get('work-summary', [])
              if not summaries: continue
              
              put_code = summaries[0].get('put-code')
              print(f"Fetching BibTeX for put-code: {put_code}")
              
              work_url = f"https://pub.orcid.org/v3.0/{orcid_id}/work/{put_code}"
              work_res = requests.get(work_url, headers={"Accept": "application/x-bibtex"})
              
              if work_res.status_code == 200:
                  bib_content.append(work_res.text)
              else:
                  print(f"Error fetching {put_code}: {work_res.status_code}")
              
              time.sleep(0.1) # Be kind to the API

          # 3. Write the file (This replaces the old one entirely)
          with open(output_file, 'w') as f:
              f.write("\n\n".join(bib_content))
          
          print(f"Successfully wrote {len(bib_content)} entries to {output_file}")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name 'ORCID-Bot'
          git config --global user.email 'bot@github.com'
          git add _publications/papers.bib
          git commit -m "Full rewrite of papers.bib from ORCID" || exit 0
          git push
