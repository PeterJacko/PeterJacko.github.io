name: Sync ORCID Publications
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  orcid-to-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install bibtexparser
        run: pip install bibtexparser

      - name: Fetch BibTeX from ORCID
        run: |
          # 1. Ensure the directory exists
          mkdir -p _publications
          
          # 2. Fetch the file
          curl -L "https://pub.orcid.org/v3.0/0000-0003-3376-0260/external-identifiers" -H "Accept: application/x-bibtex" > _publications/papers.bib

          # 3. Run a simple python script to split the BibTeX into .md files
          python - <<EOF
          import bibtexparser
          import os
          
          with open('papers.bib') as bibtex_file:
              bib_database = bibtexparser.load(bibtex_file)
          
          for entry in bib_database.entries:
              filename = f"_publications/{entry.get('year', '0000')}-{entry['ID']}.md"
              with open(filename, 'w') as f:
                  f.write("---\n")
                  f.write(f"title: \"{entry['title']}\"\n")
                  f.write(f"collection: publications\n")
                  f.write(f"date: {entry.get('year', '0000')}-01-01\n")
                  f.write(f"venue: \"{entry.get('journal', entry.get('booktitle', 'Unknown'))}\"\n")
                  f.write("---\n")
                  f.write(f"\n{entry.get('abstract', '')}\n")
          EOF

      - name: Commit changes
        run: |
          git config --global user.name 'ORCID-Bot'
          git config --global user.email 'bot@github.com'
          git add _publications/papers.bib
          # Added || echo to prevent failure if there are no changes to commit
          git commit -m "Auto-update publications bib" || echo "No changes to commit"
          git push
