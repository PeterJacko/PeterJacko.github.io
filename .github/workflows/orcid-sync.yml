name: Sync ORCID to Single Bib
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Run Sync Script
        run: |
          python3 - <<EOF
          import requests
          import os
          import time

          orcid_id = "0000-0003-3376-0260"
          output_file = "_publications/papers.bib"
          
          if not os.path.exists("_publications"):
              os.makedirs("_publications")

          print(f"Fetching summary for {orcid_id}...")
          # Using the /works endpoint for a cleaner JSON list
          url = f"https://pub.orcid.org/v3.0/{orcid_id}/works"
          response = requests.get(url, headers={"Accept": "application/json"})
          
          if response.status_code != 200:
              print(f"API Error: {response.status_code}")
              exit(1)

          data = response.json()
          
          # This is the specific path for your profile
          groups = data.get('group', [])
          
          # FALLBACK: If group is not at root, try activities-summary path
          if not groups:
              groups = data.get('activities-summary', {}).get('works', {}).get('group', [])

          print(f"Groups found: {len(groups)}")

          bib_content = []
          for group in groups:
              # Each group contains 'work-summary'
              summaries = group.get('work-summary', [])
              for work in summaries:
                  put_code = work.get('put-code')
                  if not put_code: continue
                  
                  print(f"Downloading BibTeX for: {put_code}")
                  work_url = f"https://pub.orcid.org/v3.0/{orcid_id}/work/{put_code}"
                  work_res = requests.get(work_url, headers={"Accept": "application/x-bibtex"})
                  
                  if work_res.status_code == 200 and len(work_res.text) > 10:
                      bib_content.append(work_res.text)
                  
                  time.sleep(0.05) # Faster but safe

          if bib_content:
              with open(output_file, 'w') as f:
                  f.write("\n\n".join(bib_content))
              print(f"SUCCESS: Wrote {len(bib_content)} entries.")
          else:
              print("ERROR: No BibTeX content was gathered.")
              # Write a small comment so the file isn't 0 bytes
              with open(output_file, 'w') as f:
                  f.write("% No publications found or privacy settings blocked access.")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name 'ORCID-Bot'
          git config --global user.email 'bot@github.com'
          git add _publications/papers.bib
          git commit -m "Updated papers.bib" || exit 0
          git push
