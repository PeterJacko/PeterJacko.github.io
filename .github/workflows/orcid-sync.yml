name: Sync ORCID Publications
on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  orcid-to-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install bibtexparser
        run: pip install bibtexparser

      - name: Fetch and Convert ORCID
        run: |
          # 1. Ensure directory exists
          mkdir -p _publications
          
          # 2. Fetch BibTeX (Added -f to fail on error and -L to follow redirects)
          curl -f -L "https://pub.orcid.org/v3.0/0000-0003-3376-0260/works" \
               -H "Accept: application/x-bibtex" > papers.bib || echo "Download failed"

          # 3. Python script with extra error checking
          python - <<EOF
          import bibtexparser
          import os

          if not os.path.exists('papers.bib') or os.path.getsize('papers.bib') == 0:
              print("No papers.bib found or file is empty.")
              exit(0)

          with open('papers.bib') as bibtex_file:
              bib_database = bibtexparser.load(bibtex_file)

          if not bib_database.entries:
              print("No entries found in BibTeX.")
              exit(0)

          for entry in bib_database.entries:
              category = "Journal"
              if entry.get('ENTRYTYPE') == 'inproceedings':
                  category = "Conference"
              elif entry.get('ENTRYTYPE') == 'book':
                  category = "Book"
              
              clean_id = entry['ID'].replace('/', '_').replace(':', '_')
              filename = f"_publications/{entry.get('year', '0000')}-{clean_id}.md"
              
              with open(filename, 'w') as f:
                  f.write("---\n")
                  f.write(f"title: \"{entry.get('title', 'Untitled')}\"\n")
                  f.write(f"collection: publications\n")
                  f.write(f"category: {category}\n")
                  f.write(f"date: {entry.get('year', '0000')}-01-01\n")
                  f.write(f"venue: \"{entry.get('journal', entry.get('booktitle', 'Unknown'))}\"\n")
                  f.write("---\n")
                  f.write(f"\n{entry.get('abstract', 'No abstract available.')}\n")
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name 'ORCID-Bot'
          git config --global user.email 'bot@github.com'
          # We add the whole directory instead of a wildcard to avoid the pathspec error
          git add _publications
          git commit -m "Auto-sync ORCID publications" || exit 0
          git push
